---
title: Electric vehicle
sidebarTitle: Electric vehicle
description: This guide shows how to utilise Flatpeak to optimise EV charging schedules to minimise and accurately report energy costs.
---

<Frame>
  <img
    src="/images/use-case-ev.png"
  />
</Frame>

<Note>If you need to account for the solar component of energy that is going into the vehicle or/and are implementing V2H, V2G or VPP, [schedule a call](https://flatpeak.com/schedule-a-call) with our team for implementation advice.</Note>

## Design

#### To optimise charging of the EV by energy cost, we need to:

Once the customer completes the [Connect flow](/quickstart#2-run-connect-flow), or if you [imported their tariff](/guides/importing-your-data):

1. When the vehicle connects to a charging station, obtain its SoC & ready-by time.
2. Call [schedules](/api-reference/zero/schedules/create-a-schedule) API to calculate a cost-optimised charging schedule.
3. Send this schedule to the vehicle.

#### To display charging costs:

1. Log the transferred energy to the [meter records](/api-reference/zero/meters/submit-interval-meter-records) API under the IMPORT tariff.
2. When you want to display the charging costs, call the API to get them by [charging session](/api-reference/zero/costs/calculate-energy-cost-by-session-id) (including in real-time) or [day/month/year](/api-reference/zero/costs/calculate-energy-cost-by-time-interval).

## Implementation

<AccordionGroup>

<Accordion icon="clock" title="Create charging schedule">

To create a cost-optimised charging schedule, you will need:

1. Time when charging can start (i.e. when the vehicle was plugged in).
2. Amount of energy required in KWH.
3. Expected charging speed (use charger rating or 7KW for AC charging).
4. Time when charging must be completed (i.e. ready-by or departure time).

Call the [Scheduling API](/api-reference/zero/schedules/create-a-schedule) to create an IMPORT schedule that follows a low tariff.

In the example vehicles require 5,3KWH. Charging can start at 7 pm must be completed by 5 am the following day. The schedule instructs the vehicle to start charging at 1 am and stop at 5 am `schedule.start_time` and `schedule.end_time`.

<CodeGroup>
```json Request
curl --request POST \
  --url https://api.flatpeak.com/schedules \
  --header 'Authorization: Bearer <token>' \
  --header 'Content-Type: application/json' \
  --data '{
    "location_id": "loc_641b90b758fb8e6293716e40",
    "max_power": {
      "units": "W",
      "value": "7000"
    },
    "data": [
      {
        "device_id": "dev_664525107c44d88a37ca1ad7",
        "direction": "IMPORT",
        "start_time": "2024-08-01T19:00:00Z",
        "end_time": "2024-08-02T05:00:00Z",
        "max_power": {
          "units": "W",
          "value": 7000
        },
        "energy": {
          "units": "WH",
          "value": 5300
        }
      }
    ]
  }'
```
```json Response
{
  "id": "sch_65ea3fb185c1541f247c251e",
  "object": "schedule",
  "location_id": "loc_641b90b758fb8e6293716e40",
  "currency_code": "EUR",
  "data": [
    {
      "device_id": "dev_664525107c44d88a37ca1ad7",
      "direction": "IMPORT",
      "energy": {
        "units": "WH",
        "value": 5300
      },
      "tariff": {
        "value": 928.372,
        "confidence": 1
      },
      "schedule": [
        {
          "start_time": "2024-08-02T01:00:00Z",
          "end_time": "2024-08-02T05:00:00Z",
          "power": {
            "units": "W",
            "value": 7000
          }
        }
      ]
    }
  ]
}
```
</CodeGroup>

</Accordion>

<Accordion icon="meter" title="Log transferred energy">
Call [Metering API](/api-reference/zero/meters/submit-interval-meter-records) and submit IMPORT metering (at the device level) when the vehicle is charging. Set `direction=IMPORT` and `tariff_rate=IMPORT`.

<Check>**IMPORTANT**: In order for you to later display energy cost by charging session, make sure to include session identifier as `session_reference_id=SESSION123`.</Check>

<CodeGroup>
```json Request
curl --request POST \
  --url https://api.flatpeak.com/meters/interval \
  --header 'Authorization: Bearer <token>' \
  --header 'Content-Type: application/json' \
  --data '{
  "start_time": "2024-08-02T01:00:00Z",
  "end_time": "2024-08-02T02:00:00Z",
  "device_id": "dev_65e6d8334c8d715963d99db3",
  "location_id": "loc_641b90b758fb8e6293716e40",
  "session_reference_id": "SESSION123",
  "direction": "IMPORT",
  "tariff_rate": "IMPORT",
  "units": "W",
  "value": 2034
}'
```
```json Response
{
  "id": "bat_65e42b7827c0526548432b9f",
  "object": "meter_batch",
  "records_submitted": 1,
  "records_accepted": 1,
  "records_processed": 1
}
```
</CodeGroup>

<Tip>If you want to display charging cost in real-time, use [instant-cost-calculate](/api-reference/zero/costs/instantly-calculate-energy-cost) API</Tip>

</Accordion>

<Accordion icon="sack-dollar" title="Display charging costs">
<Tabs>
<Tab title="By session ID">
When you need to display the cost of charging, call [calculate-cost-by-interval](/api-reference/zero/costs/calculate-energy-cost-by-time-interval) API endpoint to show the cost of charging aggregated by day/month/year. To display the cost per charging session, call the [calculate-cost-by-session](/api-reference/zero/costs/calculate-energy-cost-by-session-id) endpoint.

<CodeGroup>
```json Request
curl --request POST \
  --url 'https://api.flatpeak.com/costs/session/SESSION123 \
  ?direction=IMPORT \
  &include_tariff=true' \
  --header 'Authorization: Bearer <token>'
```
```json Response
{
  "id": "ecs_65ea3fb185c1541f247c251e",
  "object": "energy_cost",
  "object_id": "dev_65e6d8334c8d715963d99db3",
  "live_mode": true,
  "direction": "IMPORT",
  "location_timezone": "Europe/London",
  "currency_code": "EUR",
  "energy_units": "WH"
  "data": [
    {
      "session_reference_id": "SESSION123",
      "start_time": "2023-06-16T01:00:00Z",
      "end_time": "2023-06-16T01:30:00Z",
      "energy": {
        "value": 8214
      },
      "tariff": {
        "value": 928.372,
        "confidence": 1
      }
    }
  ]
}
```
</CodeGroup>
</Tab>
<Tab title="By day/month/year">
When you want to display the cost of energy that has been transferred via your device aggregated by day, month or year, use [calculate-energy-cost-by-time-interval](/api-reference/zero/costs/calculate-energy-cost-by-time-interval) API:

<CodeGroup>
```json Request
curl --request POST \
  --url 'https://api.flatpeak.com/costs/interval/dev_65e6d8334c8d715963d99db3 \
  ?aggregation=MONTH \
  &direction=IMPORT \
  &include_tariff=true' \
  --header 'Authorization: Bearer <token>' \
  --header 'Content-Type: application/json' \
  --data '{
  "start_time": "2023-11-07T05:31:56Z",
  "end_time": "2023-12-07T05:31:56Z"
}'
```
```json Response
{
  "id": "ecs_65ea3fb185c1541f247c251e",
  "object": "energy_cost",
  "object_id": "dev_65e6d8334c8d715963d99db3",
  "live_mode": true,
  "direction": "IMPORT",
  "location_timezone": "Europe/London",
  "currency_code": "EUR",
  "energy_units": "WH"
  "data": [
    {
      "start_time": "2023-11-07T05:31:56Z",
      "end_time": "2023-12-07T05:31:56Z",
      "energy": {
        "value": 10284
      },
      "tariff": {
        "value": 928.372,
        "confidence": 1
      }
    }
  ]
}
```
</CodeGroup>
</Tab>
</Tabs>
</Accordion>

</AccordionGroup>
